<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="generator" content="Doxygen 1.9.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SageOS: 测试框架使用说明</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeParagraphLink.init()
    </script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?5ff7026a06b8ba529359a49916952b2f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
    <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                    <tr style="height: 56px;">
                        <td id="projectalign" style="padding-left: 0.5em;">
                            <div id="projectname">SageOS
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_test__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">测试框架使用说明 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md3"></a>
介绍</h1>
<p >目前测试框架更名为 <code>test</code>，并且做了许多简化和使用改进。现在不再是每个测试一个子目录，而是所有测试都在这个目录中。</p>
<p >**注意（2022/04/11更新）原有一键测试命令 <code>make run</code> 现更名为 <code>make test</code>，<code>make run</code> 现用于运行单一测试！</p>
<p >注意：原有的 <code>tests</code> 文件夹已经删除，请不要再对它进行操作！</p>
<p >测试框架支持以下功能：</p>
<ul>
<li>一键回归测试</li>
<li>编译/运行单个单元测试</li>
<li>调试单个单元测试（native 和 x86_64-qemu）</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
目录结构说明</h2>
<div class="fragment"><div class="line">.</div>
<div class="line">├── build       # 存放编译后的可执行文件</div>
<div class="line">├── out         # 存放测试输出（stdout重定向）</div>
<div class="line">├── include     # 存放头文件</div>
<div class="line">└── units       # 存放单元测试</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md5"></a>
行为说明</h2>
<p >下面以 <code>make test</code> 为例，说明当你运行回归测试时发生了什么：</p>
<ol type="1">
<li>GNU make 程序读取 <code>test/Makefile</code> 文件并执行 <code>run</code> target</li>
<li>将会扫描 <code>units</code> 下的每一个 .c 文件，并为它生成对应的 <code>Makefile.xxx</code></li>
<li>接着，脚本将会自动运行 <code>make -f Makefile.xxx</code>，进行编译并运行（编译时会链接 AM 和 kernel）</li>
<li><a class="el" href="trm_8c.html#aa12a9403d4e36817688700b1c1bd442e">main()</a> 函数将会被执行，程序的输出将重定向到 <code>out/xxx.out</code> 目录中，脚本将会检查运行是否成功<ul>
<li>如果是 <code>native</code> 架构，直接检查返回值即可</li>
<li>如果是 <code>x86-64_qemu</code> 架构，将会检查 <code>out/xxx.out</code> 中 CPU 的 halt 返回值，若非0则判断测试失败</li>
</ul>
</li>
<li>打印出测试结果</li>
</ol>
<h1><a class="anchor" id="autotoc_md6"></a>
使用</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
编写单元测试</h2>
<p ><code>units</code> 下可以有两种文件：</p><ul>
<li><code>test_</code> 开头的 c 程序将被视作自动化测试，要求不能陷入死循环</li>
<li>其他程序将用于运行和展示，可以死循环</li>
</ul>
<p >你可以参考 <code>test_add.c</code> 文件，使用数组对多种输入输出进行判断。</p>
<p >在编写时，如果你的测试比较庞大，建议使用 <code>logger</code> 而不是 <code>printf</code> 打印结果。</p>
<h2><a class="anchor" id="autotoc_md8"></a>
环境变量</h2>
<p >你可以直接执行 <code>export</code> 定义环境变量，也可以在 make 命令中加入环境变量。建议使用前者，例如：</p>
<div class="fragment"><div class="line">export smp=4</div>
<div class="line">export LOG_MASK=15</div>
</div><!-- fragment --><p >可配置的环境变量有：</p>
<ul>
<li><code>ARCH</code>: 当前支持 <code>native</code> 和 <code>x86_64-qemu</code>, 若 ARCH 不指定，则默认为 <code>x86_64-qemu</code>.</li>
<li><code>smp</code>: 处理器数量，默认为 2</li>
<li><code>CFLAGS_EXTRA</code>: gcc 编译时的额外选项，默认为空。例如 <code>"-DSIMULATE_PMM"</code> （已默认加上 <code>-DTEST</code> 和 <code>-DLOG_MASK=xxx</code>）</li>
<li><code>LOG_MASK</code>: logger 输出mask, 详见 logger.h. 默认输出 <a class="el" href="logger_8h.html#a5b9a882fdc463a3d4dcc99840fd0adb8">error(8)</a>, <a class="el" href="logger_8h.html#aaa6ad2ce683c5c5f5984faef407531d7">warn(4)</a>, <a class="el" href="logger_8h.html#a8ee1f79b193a2069a4f74c155ce97f66">info(2)</a>, 也就是说默认值为14. 如果你要输出success(1)，设置为15即可</li>
</ul>
<h2><a class="anchor" id="autotoc_md9"></a>
运行测试</h2>
<p ><b>运行全部测试：</b></p>
<div class="fragment"><div class="line">make test</div>
</div><!-- fragment --><p >如果出现错误，可以查看 <code>out</code> 文件夹内的输出内容。</p>
<p ><b>运行单个测试：</b></p>
<div class="fragment"><div class="line">make run target=xxx</div>
</div><!-- fragment --><p >必须要指定 <code>target=xxx</code>，其中 <code>xxx</code> 是在 <code>units</code> 目录下的文件名（没有 .c 后缀）。</p>
<p ><b>调试单个测试：</b></p>
<p >为了便于调试单个测试，编写了 vscode 的相应调试配置，你只需要把 <code>.vscode</code> 目录下的模板文件复制一份（注意不要删除或直接改名）并更名为 <code>launch.json</code> 和 <code>tasks.json</code> 即可使用。</p>
<p >如果你要调试native，在对应单元测试文件上直接调试，配置选择 <code>unit test (native)</code> 即可。</p>
<p >如果你要调试QEMU，运行如下命令：</p>
<div class="fragment"><div class="line">make debug target=xxx</div>
</div><!-- fragment --><p >并在对应单元测试文件运行调试配置 <code>unit test (QEMU)</code> 即可。</p>
<p ><b>清除编译文件</b></p>
<div class="fragment"><div class="line">make clean</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
问题和注意事项</h1>
<ol type="1">
<li>如果更改代码后运行结果还是出错，请 <code>make clean</code>；若清除后仍出现错误的文件链接或使用了此前的编译文件，请删除项目内所有 build 目录（包括 am/klib/kernel 等目录下的 build 目录）并重试。</li>
<li>运行在 <code>native</code> 架构时，将不会链接 <code>klib</code>，而是使用标准库函数。</li>
<li>调试时若出现与 signal 有关的错误，请检查 launch.json 配置是否正常。如果用 gdb 命令行，需要执行 <code>handle SIGUSR1 SIGUSR2 SIGSEGV noprint nostop</code>.</li>
<li>编译单元测试链接 <code>kernel</code> 时，将不会编译 <code><a class="el" href="main_8c.html">kernel/framework/main.c</a></code> 文件，这使得单元测试内的 main 函数可以被执行。</li>
<li>如果不希望链接 <code>kernel</code>，可以添加 <code>NOKERNEL=true</code> 选项到命令中。</li>
<li>编译单元测试时将会 define TEST 标志。如果需要在测试框架以外写测试逻辑，可以借助 <code>#ifdef TEST</code> 实现。<code>os_run</code> 函数使用了这个方法。 </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
